<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floppyfy Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a1a;
            color: #e0e0e0 !important;
        }

        .card {
            background-color: #2d2d2d;
            border: 1px solid #444;
            color: #e0e0e0 !important;
        }

        .card-title,
        .card-subtitle,
        .card-text,
        .card-body {
            color: #e0e0e0 !important;
        }

        .form-control,
        .form-select {
            background-color: #2d2d2d;
            border-color: #555;
            color: #e0e0e0 !important;
        }

        .form-control:focus,
        .form-select:focus {
            background-color: #3a3a3a !important;
            border-color: #1db954 !important;
            color: #ffffff !important;
            box-shadow: 0 0 0 0.2rem rgba(29, 185, 84, 0.25) !important;
        }

        .form-control::placeholder {
            color: #888;
        }

        .form-label,
        .form-check-label {
            color: #e0e0e0 !important;
        }

        .btn-primary {
            background-color: #1db954;
            border-color: #1db954;
            color: #fff !important;
        }

        .btn-primary:hover {
            background-color: #1ed760;
            border-color: #1ed760;
        }

        .btn-secondary {
            background-color: #444;
            border-color: #555;
            color: #e0e0e0 !important;
        }

        .btn-secondary:hover {
            background-color: #555;
        }

        .btn-danger {
            background-color: #dc3545;
            color: #fff !important;
        }

        .btn-outline-light {
            border-color: #555;
            color: #e0e0e0 !important;
        }

        .btn-outline-light:hover {
            background-color: #444;
            color: #fff !important;
            border-color: #666;
        }

        .text-muted {
            color: #999 !important;
        }

        h1,
        h3,
        h5,
        h6 {
            color: #f0f0f0 !important;
        }

        small {
            color: #aaa !important;
        }

        .input-group-text {
            background-color: #2d2d2d;
            border-color: #555;
            color: #e0e0e0 !important;
        }

        /* Playback Controls styling */
        .playback-controls .btn-playback {
            width: 44px;
            height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1.5px solid rgba(255, 255, 255, 0.2);
            color: #e0e0e0;
            background: rgba(255, 255, 255, 0.05);
            padding: 0;
            margin-right: 12px;
        }

        .playback-controls .btn-playback:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #1db954;
            color: #1db954;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .playback-controls .btn-playback:active {
            transform: scale(0.95);
        }

        #now_playing_container .card {
            background: linear-gradient(180deg, #333 0%, #222 100%);
            border: 1px solid #444;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
        }

        #now_playing_art {
            transition: transform 0.3s ease;
        }

        #now_playing_art:hover {
            transform: scale(1.02);
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <h1 class="mb-4">Floppyfy <small class="text-muted">NFC Music Controller</small></h1>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <a href="/settings" class="btn btn-outline-light">Settings</a>
        </div>

        <!-- Now Playing -->
        <div id="now_playing_container" style="display: none;">
            <div class="card mb-4 border-success shadow">
                <div class="card-header d-flex justify-content-between align-items-center bg-dark">
                    <span>Now Playing</span>
                    <span id="playback_status" class="badge bg-success">Active</span>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <img id="now_playing_art" src="" class="rounded me-3 shadow"
                            style="width: 120px; height: 120px; object-fit: cover; border: 2px solid #1db954;"
                            alt="Album Art">
                        <div class="flex-grow-1">
                            <h4 id="now_playing_title" class="mb-1 text-white">Unknown Track</h4>
                            <p id="now_playing_artist" class="mb-1 text-info" style="font-size: 1.1rem;">Unknown Artist
                            </p>
                            <p id="now_playing_album" class="text-muted small mb-3">Unknown Album</p>

                            <div class="playback-controls mt-4">
                                <button onclick="controlPlayback('previous')" class="btn-playback" title="Previous">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor"
                                        viewBox="0 0 16 16">
                                        <path
                                            d="M4 4a.5.5 0 0 1 1 0v3.248l6.267-3.636c.54-.313 1.232.066 1.232.696v7.384c0 .63-.692 1.01-1.232.697L5 8.753V12a.5.5 0 0 1-1 0V4z" />
                                    </svg>
                                </button>
                                <button onclick="controlPlayback('next')" class="btn-playback" title="Next">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor"
                                        viewBox="0 0 16 16">
                                        <path
                                            d="M12.5 4a.5.5 0 0 0-1 0v3.248L5.233 3.612C4.693 3.3 4 3.678 4 4.308v7.384c0 .63.692 1.01 1.233.697L11.5 8.753V12a.5.5 0 0 0 1 0z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add New Tag -->
        <div class="card mb-4">
            <div class="card-header"><span id="form_title">Add New Tag</span></div>
            <div class="card-body">
                <form action="/add_tag" method="POST" id="tag_form" onsubmit="return validateTagSubmit()">
                    <div class="mb-3">
                        <label class="form-label">UID (Scan to Autofill)</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="uid" id="uid_input" required
                                placeholder="00:00:00:00">
                            <button class="btn btn-secondary" type="button" id="scan_btn" onclick="fetchScan()">Get Last
                                Scanned</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" name="name" id="name_input"
                            placeholder="Daft Punk Album">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <select class="form-select" name="type" id="type_select">
                            <option value="spotify">Spotify URI</option>
                            <option value="file">Network/File URL</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">URI / URL</label>
                        <input type="text" class="form-control" name="uri" id="uri_input"
                            placeholder="spotify:album:...">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" name="shuffle" id="shuffle_check">
                        <label class="form-check-label" for="shuffle">Shuffle</label>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Tag</button>
                </form>
            </div>
        </div>

        <!-- Existing Tags -->
        <h3>Existing Tags</h3>
        <script>
            // Existing tag UIDs for duplicate checking
            const existingUIDs = new Set({{ tags.keys() | list | tojson }});
        </script>
        <div class="row">
            {% for uid, data in tags.items() %}
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-start">
                            {% if data.cover_url %}
                            <img src="{{ data.cover_url }}" class="rounded me-3 shadow-sm"
                                style="width: 100px; height: 100px; object-fit: cover; border: 1px solid #444;"
                                alt="Cover">
                            {% endif %}
                            <div class="flex-grow-1">
                                <h5 class="card-title">{{ data.name }}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">{{ uid }}</h6>
                                <p class="card-text mb-3" style="font-size: 0.9rem;">
                                    Type: <span class="badge bg-secondary">{{ data.type }}</span><br>
                                    URI: <code
                                        class="text-info">{{ data.uri[:30] }}{{ '...' if data.uri|length > 30 }}</code><br>
                                    Shuffle: {{ '✅' if data.shuffle else '❌' }}
                                </p>
                            </div>
                        </div>
                        <div class="mt-2 text-end">
                            <button class="btn btn-sm btn-outline-warning me-2"
                                onclick="editTag('{{ uid }}', '{{ data.name }}', '{{ data.uri }}', '{{ data.type }}', {{ 'true' if data.shuffle else 'false' }})">Edit</button>
                            <form action="/delete_tag" method="POST" style="display:inline">
                                <input type="hidden" name="uid" value="{{ uid }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        async function fetchScan() {
            try {
                const response = await fetch('/scan_api');
                const data = await response.json();
                if (data.uid) {
                    document.getElementById('uid_input').value = data.uid;
                } else {
                    alert("No tag detected recently.");
                }
            } catch (e) {
                console.error(e);
            }
        }

        function editTag(uid, name, uri, type, shuffle) {
            // Populate the form
            document.getElementById('uid_input').value = uid;
            document.getElementById('name_input').value = name;
            document.getElementById('uri_input').value = uri;
            document.getElementById('type_select').value = type;
            document.getElementById('shuffle_check').checked = shuffle;

            // Update form title
            document.getElementById('form_title').textContent = 'Edit Tag';

            // Scroll to form
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
        }

        function validateTagSubmit() {
            const uid = document.getElementById('uid_input').value.trim();
            const name = document.getElementById('name_input').value.trim();

            // Check if UID already exists
            if (existingUIDs.has(uid)) {
                const confirmOverwrite = confirm(
                    `⚠️ WARNING: A tag with UID "${uid}" already exists!\n\n` +
                    `You are about to replace: "${name}"\n\n` +
                    `Click OK to OVERWRITE the existing tag, or Cancel to change the UID.`
                );
                return confirmOverwrite;
            }
            return true;
        }

        async function updateNowPlaying() {
            try {
                const response = await fetch('/now_playing');
                const data = await response.json();

                const container = document.getElementById('now_playing_container');
                if (data && data.title && data.title !== "") {
                    container.style.display = 'block';
                    document.getElementById('now_playing_title').textContent = data.title;
                    document.getElementById('now_playing_artist').textContent = data.artist || 'Unknown Artist';
                    document.getElementById('now_playing_album').textContent = data.album || 'Unknown Album';

                    const art = document.getElementById('now_playing_art');
                    if (data.album_art) {
                        art.src = data.album_art;
                        art.style.display = 'block';
                    } else {
                        art.style.display = 'none';
                    }
                } else {
                    container.style.display = 'none';
                }
            } catch (e) {
                console.error("Now playing poll error:", e);
            }
        }

        async function controlPlayback(action) {
            try {
                await fetch(`/${action}`, { method: 'POST' });
                // Refresh immediately after action
                setTimeout(updateNowPlaying, 500);
            } catch (e) {
                console.error("Control action error:", e);
            }
        }

        // Poll every 3 seconds
        setInterval(updateNowPlaying, 3000);
        updateNowPlaying();
    </script>
</body>

</html>